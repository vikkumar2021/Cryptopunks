<!DOCTYPE html>

<!-- To view in browser: python3 -m http.server 8080 & -->
<!-- Then visit http://0.0.0.0:8080/interactive.html in your browser -->
<head>
  <title>Games Rating: 2015 - 2019</title>
  <meta charset="utf-8">
  <style>

      path {
        fill: none;
        stroke-width: 2px;
      }

      text {
        fill: black;
        font: 12px sans-serif;
        pointer-events: none;
        font-weight:  bold;
      }

  </style>
</head>

<body>
  <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
  <script type="text/javascript" src="static/lib/d3-dsv.min.js"></script>

  <!-- Example hiding an element -->
  <!-- <g id="" style"display:none;" /> -->

  <!-- Example of styling an element -->
  <!-- svg_element.style()-->

  <script>
    // define the dimensions and margins for the line chart
    // Use the same Margin Convention from HW1 Q3: https://poloclub.github.io/cse6242-2022spring-online/hw1/8rEHLaYmr9 _margin_convention.pdf to layout your graph


    // define the dimensions and margins for the bar chart
    var margin = {top: 50, right: 50, bottom: 50, left: 100};
    var width = 960 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;

    // append svg element to the body of the page
    // set dimensions and position of the svg element
    let svg = d3
      .select("body")
      .append("svg")
      .attr("id", "line_chart")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("id", "container")
      .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");



    var bar_margin = {top: 50, right: 50, bottom: 50, left: 150};
    var bar_width = 960 - bar_margin.left - bar_margin.right,
      bar_height = 500 - bar_margin.top - bar_margin.bottom;

    bar_chart_title = d3.select("body")
      .append("div")
      .attr("width", bar_width)
      .attr("id", "bar_chart_title")
      .attr("transform",
        "translate(" + bar_margin.left + "," + bar_margin.top + ")");

    let svg_bar = d3
      .select("body")
      .append("svg")
      .attr("id", "bar_chart")
      .attr("width", bar_width + bar_margin.left + bar_margin.right)
      .attr("height", bar_height + bar_margin.top + bar_margin.bottom)
      .append("g")
      .attr("id", "container_2")
      .attr("transform",
        "translate(" + bar_margin.left + "," + bar_margin.top + ")");

    bars_group = svg_bar.append("g")
      .attr("id", "bars");

    bars_y_axis = svg_bar.append("g")
      .attr("id", "y-axis-bars");

    bars_x_axis = svg_bar.append("g")
      .attr("id", "x-axis-bars")
      .attr("transform", "translate(0," + bar_height + ")");

    bar_y_axis_label = svg_bar
      .append("text")
      .attr("id", "bar_y_axis_label");

    bar_x_axis_label = svg_bar
      .append("text")
      .attr("id", "bar_x_axis_label");

    // Fetch the data
  	var pathToCsv = "static/average-rating.csv";

    var parseTime = d3.timeParse("%Y");

    var colors = {'2015': 'red', '2016': 'green', '2017': 'blue', '2018': 'purple', '2019': 'orange'};


    d3.dsv(",", pathToCsv, function (d) {
      return {
        name: d.name,
        year: +d.year,
        average_rating: +d.average_rating,
        users_rated: +d.users_rated
      }
    }).then(function (data_raw) {
        data = data_raw.filter(function(d) {
          if(d.year >= 2015 && d.year <= 2019) {
            d.average_rating = Math.floor(d.average_rating)
            return d;
          }
        })
        console.log(data_raw.length); // you should see the data in your browser's developer tools console
        console.log(data.length);
        console.log(data);


        // TRANSFORM DATA
        function createSummary() {
            var years = [2015, 2016, 2017, 2018, 2019];
            var ratings = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
            var summary = {}
            years.map(function(d) { summary[d] = {} });
            for (i=0; i < years.length; i++) {
                for (j=0; j < ratings.length; j++) {
                  year = years[i];
                  rating = ratings[j];
                  summary[year][rating] = 0;
                }
            }

            return summary;
        }

        var histogram = createSummary();
        for (i=0; i < data.length; i++) {
            year = data[i].year;
            rating = data[i].average_rating;
                histogram[year][rating] += 1
        }
        console.log(histogram);
        histogram_entries = d3.entries(histogram);

        var data2 = [];
        for (const [key1, value1] of Object.entries(histogram)) {
            // console.log(key1, value1);
            for (const [key2, value2] of Object.entries(value1)) {
              // console.log(key2, value2);
              data2.push({"year": key1, "rating": +key2, "count": value2});
            }
          }


        // TITLE & CREDIT
        svg.append("text")
           .attr("id", "line_chart_title")
           .attr("x", width/2)
           .attr("y", -margin.top/2)
           .attr("text-anchor", "middle")
           .style("font-size", "16px")
           .text("Board games by Rating 2015-2019");

        svg.append("text")
           .attr("id", "credit")
           .attr("x", width/2)
           .attr("y", -margin.top/2 + 15)
           .attr("text-anchor", "middle")
           .style("font-size", "12px")
           .text("smukhi6");


        // CREATE AXES
        var max_rating = d3.max(data.map(function(d) { return d.average_rating;}));
        console.log(max_rating);

        rating_counts = d3.entries(histogram).map(function(d) { return d3.entries(d.value).map(function (d) { return d.value; }); });
        var max_count = d3.max(rating_counts.flat(1));
        console.log(max_count);

        var scaleX = d3.scaleLinear().domain([0, max_rating])
            .range([0, width])

        var scaleY = d3.scaleLinear().domain([0, max_count])
            .range([height, 0])

        var xAxis = d3.axisBottom().scale(scaleX).ticks(10);
        svg.append("g")
          .attr("id", "x-axis-lines")
          .attr("transform", "translate(0," + height + ")")
          // .attr("transform", "translate(" + margin.left + "," + (height - margin.bottom) + ")")
          .call(xAxis)
          .append("text")
          .attr("x", width/2)
          .attr("y", (margin.bottom/2) + 10)
          .attr("text-anchor", "middle")
          .text("Rating");

        var yAxis = d3.axisLeft().scale(scaleY).ticks(10);
        svg.append("g")
          .attr("id", "y-axis-lines")
          // .attr("transform", "translate(" + margin.left + ", 0)" )
          .call(yAxis)
          .append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", -margin.left/2)
          .attr("x", -height/2)
          .style("text-anchor", "middle")
          .text("Count");


        // DRAW LINES AND LABELS (REPEAT FOR EACH GAME)
        var line = d3.line()
             .x(function(d) { return scaleX(d.key); }) // set the x values for the line generator
             .y(function(d) { return scaleY(d.value); }) // set the y values for the line generator


        lines = svg.append("g")
          .attr("id", "lines")
          .selectAll("lines")
          .data(histogram_entries)
          .enter()
          .append("path")
          .attr("d", function(d) { console.log(line(d3.entries(d.value))); return line(d3.entries(d.value)); })
          .style("stroke", function(d, i) { return colors[d.key]; });

        // ADD CIRCLES
        circles = svg.append("g")
          .attr("id", "circles")

        legend = svg.append("g")
          .attr("id", "legend")

        circles
            .selectAll("circle")
            .data(data2)
            .enter()
            .append("circle")
            .attr("cx", function(d) { return scaleX(d.rating) })
            .attr("cy", function(d) { return scaleY(d.count) })
            .attr("r", 3)
            .style("fill", function(d) { return colors[d.year]; })
            .on("mouseover", function(d) {
                console.log('mouseover', d)

                d3.select(this)
                  .attr("r", 5);

                createBarChart(d);
            })
            .on("mouseout", function() {
                console.log('mouseout')
                d3.select(this)
                  .attr("r", 3);

                svg_bar.selectAll("*").style("display", "none");
                bar_chart_title.selectAll("*").style("display", "none");
            });

        console.log(data2)

        for (var i=0; i < d3.entries(colors).length; i++) {

            legend
              .append("circle")
              .attr("cx", width)
              .attr("cy", (height/2) + (i * 20))
              .attr("r", 3)
              .style("fill", function(d) { return d3.entries(colors)[i].value; })

            legend
              .append("text")
              .attr("x", width + 5)
              .attr("y", (height/2) + (i * 20))
              .text(d3.entries(colors)[i].key)
              .style("text-anchor", "start")

        }

        /* Create bar plot using data from csv */


        // --------------------------------------------------------------- BAR CHART ---------------------------------------------------------------


        function createSummaryArr() {
            var years = [2015, 2016, 2017, 2018, 2019];
            var ratings = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
            var summary = {}
            years.map(function(d) { summary[d] = {} });
            for (i=0; i < years.length; i++) {
                for (j=0; j < ratings.length; j++) {
                  year = years[i];
                  rating = ratings[j];
                  summary[year][rating] = [];
                }
            }

            return summary;
        }

        var bar_data = createSummaryArr();
        for (i=0; i < data.length; i++) {
            year = data[i].year;
            rating = data[i].average_rating;
                bar_data[year][rating].push(data[i]);
                bar_data[year][rating].sort(function (a, b) {  return b.users_rated - a.users_rated;  })
        }
        console.log(bar_data);

        function createBarChart(d) {

            var data_subset_unsorted = bar_data[+d.year][d.rating].slice(0, 5);
            var data_subset = data_subset_unsorted.sort(function (a, b) {  return a.users_rated - b.users_rated;  })
            console.log(data_subset)
            if (data_subset.length > 0) {

                svg_bar.selectAll("*").style("display", "unset");
                bar_chart_title.style("display", "unset");

                bar_chart_title
                  .append("text")
                  .attr("x", bar_width/2)
                  .attr("y", -bar_margin.top/2)
                  .attr("text-anchor", "middle")
                  .style("font-size", "16px")
                  .text("Top " + data_subset.length + " most rated games of " + d.year + " with rating " + d.rating);

                max_ratings = d3.max(data_subset.map(function(d) { return d.users_rated; } ));
                console.log(max_ratings)

                var tick_labels = data_subset.map(function(d) { return d.name.substring(0,10); });
                console.log(tick_labels);

                // set the domains of X and Y scales based on data
                var scaleXBar = d3.scaleLinear().domain([0, max_ratings])
                    .range([0, bar_width])

                // var scaleYBar = d3.scaleLinear().domain([0, data_subset.length])
                //     .range([bar_height, 0])

                var tick_range = d3.range(tick_labels.length).map(function(d) {return d * (bar_height/tick_labels.length) ; } );
                console.log(tick_range);
                var scaleYBar = d3.scaleOrdinal().domain(tick_labels)
                    .range(tick_range)

                // BAR CHART X-AXIS
                var xAxisBar = d3.axisBottom().scale(scaleXBar);

                svg_bar
                  .select("#x-axis-bars")
                  .call(xAxisBar);

                bar_x_axis_label
                  .attr("x", bar_width/2)
                  .attr("y", bar_height + (bar_margin.bottom/2) + 10)
                  .attr("text-anchor", "middle")
                  .text("Number of users");



                // BAR CHART Y-AXIS
                var yAxisBar = d3.axisLeft()
                  .scale(scaleYBar)
                  .tickValues(tick_labels);
                  // .ticks()
                  // .ticks(data_subset.length - 2)
                  // .tickFormat(function (d) {
                  //   console.log(data_subset[d])
                  //   if ("name" in data_subset[d])
                  //     {return data_subset[d].name.substring(0, 10);}
                  // });

                svg_bar
                  .select("#y-axis-bars")
                  // .attr("transform", "translate(" + bar_margin.left + ", 0)" )
                  .call(yAxisBar);

                bar_y_axis_label
                  .attr("transform", "rotate(-90)")
                  .attr("x", -bar_height/2)
                  .attr("y", -bar_margin.left + 25)
                  .style("text-anchor", "middle")
                  .text("Games");


                // ADD BARS
                bars_group.selectAll("rect").remove();
                bars = bars_group
                  .selectAll("#bars")
                  .data(data_subset)
                  .enter()
                  
                bars
                  .append("rect")
                  .attr("y", function(d, i) { return scaleYBar(i + 1); })
                  .attr("width", function(d) {
                      return scaleXBar(d.users_rated);
                      })
                  .attr("height", ((bar_height - bar_margin.bottom - bar_margin.top) / data_subset.length) - 5)
                  .style("fill", "pink");

                // bars_group.selectAll("text").remove();
                // bars
                //   .append("text")
                //   .attr("x", -bar_margin.left/10)
                //   .attr("y", function(d, i) { return scaleYBar(i + 1) + ((bar_height - bar_margin.bottom - bar_margin.top) / data_subset.length)/2; })
                //   .style("text-anchor", "end")
                //   .text(function(d) {return d.name.substring(0, 10)})
          }
        }


    }).catch(function (error) {
      console.log(error);
    });


  </script>

</body>